<!-- chat.html -->
{% extends 'base.html' %}

{% block title %}Chat{% endblock %}

{% block content %}

    <div class="flex flex-col h-full">
        {% for user in chat_users %}
        <div class="border-b border-gray-200 mb-4 pb-4">
            <h2 class="text-lg font-semibold mb-2">{{ user.full_name() }}</h2>
            <div id="message-container-{{ user.uuid }}" class="overflow-y-auto flex flex-col space-y-2">
                {% for message in user.messages %}
                <div class="flex items-start {% if message.sender_id == current_user.uuid %} justify-end {% endif %}">
                    {% if message.sender_id != current_user.uuid %}
                    <div class="bg-gray-200 rounded-lg p-2">
                        <span class="text-gray-700">{{ message.body }}</span>
                    </div>
                    {% else %}
                    <div class="bg-blue-500 text-white rounded-lg p-2">
                        <span>{{ message.body }}</span>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            <form id="message-form-{{ user.uuid }}" class="flex justify-between mt-2">
                <input id="message-input-{{ user.uuid }}" type="text" placeholder="Type your message..." class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring focus:ring-blue-500">
                <button type="submit" class="ml-2 px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 focus:outline-none focus:ring focus:ring-blue-500">Send</button>
            </form>
        </div>
        {% endfor %}
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.3.2/socket.io.js" integrity="sha512-N2Wl5WkPmrXfbFv8SClJV4W77jbcqR3y8x1/hJy15aDqOSBlrQJYZmAVTFgCUgr2fX9bUjR9H7XXxNXQe0Y4/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script type="text/javascript">
        var socket = io();
    
        {% for user in chat_users %}
        var messageForm = document.getElementById('message-form-{{ user.uuid }}');
        var messageInput = document.getElementById('message-input-{{ user.uuid }}');
        var messageContainer = document.getElementById('message-container-{{ user.uuid }}');
    
        messageForm.addEventListener('submit', function(event) {
            event.preventDefault();
            var message = messageInput.value.trim();
            if (message !== '') {
                socket.emit('private_message', {
                    recipient: '{{ user.uuid }}',
                    message: message
                });
                messageInput.value = '';
            }
        });
        socket.on('private_message', function (data) {
            var messageContainer = document.getElementById('message-container');
            var messageElement = document.createElement('div');
            messageElement.textContent = data.sender + ': ' + data.message;
            messageContainer.appendChild(messageElement);
        });
    
        {% endfor %}
    </script>
{% endblock %}

